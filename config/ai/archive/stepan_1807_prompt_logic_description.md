# Логика работы системы синхронного перевода голос-в-голос (stepan_1707)

## Общая архитектура

Система представляет собой каскад из трех основных компонентов:
**ASR (Speech-to-Text) → LLM (Language Model) → TTS (Text-to-Speech)**

## 1. Модуль ASR (Speech-to-Text)

### Основные параметры:
- **buffer_min_words_size**: 5 слов - минимальный размер буфера для обработки
- **buffer_timeout_seconds**: 2.0 сек - таймаут буферизации речи

### Фильтрация стоп-слов:
Система исключает из обработки следующие фразы:
- "DimaTorzok"
- "субтитры сделал" / "субтитры делал"
- "M.K."
- "For more information, visit www.fema.gov"

## 2. Модуль перевода (LLM Pipeline)

### Основные настройки:
- **llm_call_timeout**: 120 сек - максимальное время ожидания ответа от LLM
- **context_window_words**: 35 слов - размер контекстного окна
- **temperature**: 0.1 - низкая температура для стабильного перевода

### Поддерживаемые языки:
- **ru**: Russian (русский)
- **en**: English (английский)

### Пайплайн обработки (5 этапов):

#### Этап 1: Добавление пунктуации к исходному контексту
- **Класс**: `llm_step.LLMStep`
- **Назначение**: Корректная расстановка знаков препинания в исходном тексте
- **Правила**: Только запятые, точки и вопросительные знаки; без кавычек, тире, скобок

#### Этап 2: Добавление пунктуации к переведенному контексту
- **Класс**: `llm_step.LLMStep`
- **Назначение**: Корректная расстановка знаков препинания в переведенном тексте
- **Аналогичные правила пунктуации**

#### Этап 3: Удаление пунктуации
- **Класс**: `prepare_step.RemovePunctuationStep`
- **Назначение**: Очистка текста от лишних знаков препинания

#### Этап 4: Частичный гейт (Partial Gate)
- **Класс**: `gate_partial_step.PartialGateStep`
- **Ключевая функция**: Разделение входного текста на две части:
  - **Строка 1**: Слова, которые можно перевести немедленно с высокой точностью
  - **Строка 2**: Слова, требующие дополнительного контекста

**Критические правила Partial Gate:**
- Удаление перекрывающихся фрагментов между контекстом и входом
- Сохранение идиом и устойчивых выражений
- Обязательная буферизация незавершенных элементов (предлоги, союзы, модальные глаголы)
- При входе >10 слов - обязательное разделение на части

#### Этап 5: Основной перевод
- **Класс**: `translation_step.TranslationStep`
- **Назначение**: Перевод текста с учетом контекста
- **Особенности**:
  - Сохранение имен собственных в оригинальном виде
  - Числа и даты записываются словами
  - Идиомы переводятся по смыслу, не дословно
  - Исключение слов-паразитов и замена ненормативной лексики

#### Этап 6: Финальная коррекция
- **Класс**: `correction_step.CorrectionStep`
- **Назначение**: Финальная полировка перевода
- **Функции**:
  - Исправление грамматики и выбора слов
  - Базовая пунктуация (только запятые и точки)
  - Обеспечение плавного присоединения к контексту

## 3. Модуль TTS (Text-to-Speech)

### Настройки аудио:
- **gap_size_bytes**: 8000 байт - размер пауз между фрагментами
- **audio_speed**: 85% - скорость воспроизведения (замедленная для лучшего восприятия)

### Голосовые модели:
Для обоих языков (ru/en) используются:
- **xtts** - основная модель
- **Dionisio Schuyler** - альтернативный голос

## Принцип работы системы

1. **Захват речи**: ASR буферизует входящую речь до достижения минимального размера или таймаута
2. **Фильтрация**: Удаление стоп-слов и нежелательных фраз
3. **Контекстная обработка**: LLM анализирует контекст и разделяет текст на готовые к переводу и требующие ожидания части
4. **Перевод**: Поэтапный перевод с учетом контекста и правил качества
5. **Синтез речи**: Преобразование переведенного текста в речь с настроенными параметрами

## Ключевые особенности

- **Потоковая обработка**: Система работает в реальном времени без ожидания завершения фраз
- **Контекстная осведомленность**: Каждый этап учитывает предыдущий контекст
- **Качественная фильтрация**: Многоуровневая система очистки и коррекции текста
- **Адаптивная буферизация**: Умное разделение текста на готовые и ожидающие части
- **Сохранение смысла**: Приоритет смысла над дословным переводом