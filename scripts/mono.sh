#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω–∞ –ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
if [ -z "$1" ]; then
    echo "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–ø—É—Ç—å_–∫_–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏>"
    exit 1
fi

# –£–∫–∞–∑—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
DIR="$1"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
if [ ! -d "$DIR" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è '$DIR' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
fi

# –ò—â–µ–º —Ñ–∞–π–ª—ã .wav, –Ω–æ –∏—Å–∫–ª—é—á–∞–µ–º —Ñ–∞–π–ª—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "stereo_"
find "$DIR" -type f -name "*.wav" ! -name "stereo_*.wav" | while read FILE; do
    # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∏ –∏–º—è —Ñ–∞–π–ª–∞
    DIRNAME=$(dirname "$FILE")
    BASENAME=$(basename "$FILE")

    # –ü—É—Ç—å –∫ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ (–æ—Ä–∏–≥–∏–Ω–∞–ª)
    BACKUP="${DIRNAME}/stereo_${BASENAME}"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è
    if [ -f "$BACKUP" ]; then
        echo "‚è≠ –ü—Ä–æ–ø—É—â–µ–Ω: $BASENAME (—É–∂–µ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω)"
        continue
    fi

    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª (–¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å)
    mv "$FILE" "$BACKUP"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª ffmpeg
    ffmpeg -i "$BACKUP" -f null - 2>/dev/null
    if [ $? -ne 0 ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å '$BACKUP'. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º."
        continue
    fi

    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–æ–Ω–æ –∏ —É–º–µ–Ω—å—à–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –¥–æ 22050 –ì—Ü
    ffmpeg -i "$BACKUP" -ac 1 -ar 22050 "$FILE" -y

    if [ $? -eq 0 ]; then
        echo "‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω: $BASENAME (–º–æ–Ω–æ, 22050 –ì—Ü), –æ—Ä–∏–≥–∏–Ω–∞–ª ‚Üí stereo_${BASENAME}"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: $BASENAME"
    fi
done

echo "üéâ –í—Å–µ —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!"
